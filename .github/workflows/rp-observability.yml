name: Satellite OIDC Guard

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  schedule:
    - cron: '0 8 * * *'

env:
  CANONICAL_ISSUER: "https://scholar-auth-jamarrlmayes.replit.app/oidc"
  JWKS_URI: "https://scholar-auth-jamarrlmayes.replit.app/oidc/jwks"

jobs:
  trust-verification:
    name: Verify OIDC Trust
    runs-on: ubuntu-latest
    steps:
      - name: Check Upstream (A1) Availability
        run: |
          echo "Verifying A1 Discovery Endpoint..."
          HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}\n" "${{ env.CANONICAL_ISSUER }}/.well-known/openid-configuration")
          
          if [ "$HTTP_CODE" -ne "200" ]; then
            echo "::error::Critical: A1 OIDC Discovery is down! (HTTP $HTTP_CODE)"
            exit 1
          fi
          echo "A1 Discovery Endpoint is reachable."

      - name: Verify Upstream JWKS
        run: |
          echo "Verifying A1 Key Rotation..."
          KEYS=$(curl -s ${{ env.JWKS_URI }} | jq '.keys | length')
          
          if [[ "$KEYS" -lt 1 ]]; then
            echo "::error::Critical: A1 is not publishing any keys for verification!"
            exit 1
          fi
          echo "A1 is publishing $KEYS active signing key(s)."

      - name: Validate Local Config (Static Analysis)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: Scan for Legacy Issuer
        run: |
          echo "Scanning for legacy configuration..."
          
          GREP_OUT=$(grep -r "scholar-auth-jamarrlmayes.replit.app" . \
            --exclude-dir={.git,.github,node_modules,venv,__pycache__} \
            --exclude="rp-observability.yml" \
            | grep -v "/oidc" \
            | grep -v "#" || true)
          
          if [ ! -z "$GREP_OUT" ]; then
            echo "::warning::Potential Legacy Issuer URL detected (missing /oidc):"
            echo "$GREP_OUT"
            echo "::warning::Please ensure all Auth Configs point to .../oidc"
          else
            echo "Local configuration appears aligned with canonical issuer."
          fi
