name: "Priority 2: Contract Tests & Backward Compatibility"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  contract-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: scholarship_api_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Needed for backward compatibility checking
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest requests fastapi uvicorn sqlalchemy psycopg2-binary
        pip install -r requirements.txt
    
    - name: Set up test environment
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/scholarship_api_test
        JWT_SECRET_KEY: test-secret-key-for-ci-testing-only-64-chars-minimum-length-required
        ENVIRONMENT: development
        DEBUG: true
        ENABLE_DOCS: true
      run: |
        echo "Test environment configured"
        echo "DATABASE_URL configured for PostgreSQL"
    
    - name: Generate OpenAPI specification
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/scholarship_api_test
        JWT_SECRET_KEY: test-secret-key-for-ci-testing-only-64-chars-minimum-length-required
        ENVIRONMENT: development
      run: |
        python -c "
        from main import app
        import json
        spec = app.openapi()
        with open('ci-current-openapi-spec.json', 'w') as f:
            json.dump(spec, f, indent=2)
        print('OpenAPI spec generated for CI')
        print(f'Paths: {len(spec.get(\"paths\", {}))}')
        print(f'Schemas: {len(spec.get(\"components\", {}).get(\"schemas\", {}))}')
        "
    
    - name: Generate contract tests
      run: |
        python tests/contract/contract_test_generator.py
        echo "Contract tests generated successfully"
        ls -la tests/contract/
    
    - name: Start API server for testing
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/scholarship_api_test
        JWT_SECRET_KEY: test-secret-key-for-ci-testing-only-64-chars-minimum-length-required
        ENVIRONMENT: development
        DEBUG: true
        PORT: 5000
      run: |
        python main.py &
        API_PID=$!
        echo "API_PID=$API_PID" >> $GITHUB_ENV
        
        # Wait for API to be ready
        timeout 60 bash -c 'until curl -f http://localhost:5000/health; do sleep 2; done'
        echo "API server started and ready"
    
    - name: Run contract tests
      env:
        API_BASE_URL: http://localhost:5000
      run: |
        cd tests/contract
        python -m pytest test_contract_generated.py::TestSchemaCompliance -v --tb=short
        python -m pytest test_contract_generated.py::TestOpenAPIContracts -v --tb=short --maxfail=10
        echo "Contract tests completed"
    
    - name: Run backward compatibility check
      run: |
        # Compare with previous OpenAPI spec if available
        if [ -f "openapi-spec-baseline.json" ]; then
          echo "Running backward compatibility check..."
          python tests/contract/backward_compatibility_checker.py ci-current-openapi-spec.json openapi-spec-baseline.json
          COMPAT_RESULT=$?
          
          if [ $COMPAT_RESULT -eq 0 ]; then
            echo "‚úÖ Backward compatibility: PASSED"
          else
            echo "‚ùå Backward compatibility: FAILED"
            echo "Breaking changes detected - see compatibility_report.json"
            # ENFORCING CI GATE: Fail build on breaking changes
            exit 1  # Priority 2 Day 1: CI gate enforcement for backward compatibility
          fi
        else
          echo "No baseline OpenAPI spec found - creating baseline"
          cp ci-current-openapi-spec.json openapi-spec-baseline.json
          echo "‚úÖ Baseline OpenAPI spec created"
        fi
    
    - name: Generate test reports
      if: always()
      run: |
        echo "=== CONTRACT TEST COVERAGE REPORT ==="
        if [ -f "tests/contract/coverage_report.json" ]; then
          python -c "
          import json
          with open('tests/contract/coverage_report.json') as f:
              report = json.load(f)
          print(f'üìä Total Endpoints: {report[\"total_endpoints\"]}')
          print(f'‚úÖ Public Endpoints: {report[\"public_endpoints\"]}')
          print(f'üîí Auth Endpoints: {report[\"auth_required_endpoints\"]}')
          print(f'üè∑Ô∏è  Tags Covered: {len(report[\"coverage_by_tag\"])}')
          "
        fi
        
        echo -e "\n=== COMPATIBILITY REPORT ==="
        if [ -f "tests/contract/compatibility_report.json" ]; then
          python -c "
          import json
          with open('tests/contract/compatibility_report.json') as f:
              report = json.load(f)
          print(f'üîç Total Changes: {report[\"total_changes\"]}')
          print(f'‚ùå Breaking Changes: {report[\"breaking_changes\"]}')
          print(f'‚ûï Additions: {report[\"additions\"]}')
          print(f'üîÑ Non-Breaking: {report[\"non_breaking_changes\"]}')
          print(f'‚úÖ Compatible: {report[\"compatible\"]}')
          "
        fi
    
    - name: Upload test artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: contract-test-reports
        path: |
          tests/contract/coverage_report.json
          tests/contract/compatibility_report.json
          ci-current-openapi-spec.json
        retention-days: 30
    
    - name: Cleanup
      if: always()
      run: |
        if [ ! -z "$API_PID" ]; then
          kill $API_PID || true
        fi
        echo "Cleanup completed"

  # Performance budgets will be added in Priority 2 Day 2
  # performance-budgets:
  #   runs-on: ubuntu-latest
  #   needs: contract-tests
  #   steps:
  #     - name: Load test with k6
  #       run: echo "Performance testing - Day 2 implementation"