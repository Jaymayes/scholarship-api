# Command Center Configuration
# Observability, Monitoring, and Alerting Setup

---
# 1. ENVIRONMENT VARIABLES (Set in .env or Replit Secrets)
environment_variables:
  # Command Center Endpoints
  COMMAND_CENTER_BASE_URL: "https://prometheus-xxx.grafana.net"
  GRAFANA_INSTANCE_URL: "https://scholarshipai.grafana.net"
  GRAFANA_API_KEY: "glc_xxxxxxxxxxxxx"  # Replace with actual key
  PROMETHEUS_URL: "https://prometheus-xxx.grafana.net/api/prom"
  LOKI_URL: "https://logs-xxx.grafana.net"
  ALERTMANAGER_URL: "https://alertmanager-xxx.grafana.net"
  
  # Service Identity
  SERVICE_ID: "scholarship-api-prod"
  SERVICE_VERSION: "1.0.0"
  SERVICE_REGION: "us-east-1"
  
  # PagerDuty Integration
  PAGERDUTY_SERVICE_KEY: "xxxxxxxxxxxxx"  # Replace with actual key
  PAGERDUTY_API_KEY: "xxxxxxxxxxxxx"
  
  # Synthetic Monitoring
  PINGDOM_API_KEY: "xxxxxxxxxxxxx"  # Optional: External health checks

---
# 2. PROMETHEUS SCRAPE CONFIG
prometheus:
  global:
    scrape_interval: 15s
    evaluation_interval: 15s
    external_labels:
      cluster: 'scholarshipai-prod'
      env: 'production'
  
  scrape_configs:
    # Scholarship API metrics
    - job_name: 'scholarship-api'
      static_configs:
        - targets: ['scholarship-api-jamarrlmayes.replit.app:5000']
      metrics_path: '/metrics'
      scrape_interval: 15s
      scrape_timeout: 10s
    
    # PostgreSQL metrics (if pg_exporter deployed)
    - job_name: 'postgresql'
      static_configs:
        - targets: ['postgres-exporter:9187']
      scrape_interval: 30s
    
    # Redis metrics (if redis_exporter deployed)
    - job_name: 'redis'
      static_configs:
        - targets: ['redis-exporter:9121']
      scrape_interval: 30s
  
  # Recording rules for golden signals
  recording_rules:
    - name: golden_signals
      interval: 30s
      rules:
        # Latency percentiles
        - record: api:http_request_duration:p50
          expr: histogram_quantile(0.50, rate(http_request_duration_seconds_bucket[5m]))
        
        - record: api:http_request_duration:p95
          expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))
        
        - record: api:http_request_duration:p99
          expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m]))
        
        # Traffic (RPS)
        - record: api:http_requests:rate1m
          expr: rate(http_requests_total[1m])
        
        # Error rate
        - record: api:http_errors:rate5m
          expr: rate(http_errors_total[5m]) / rate(http_requests_total[5m])
        
        # Saturation
        - record: api:database_pool:utilization
          expr: (database_pool_size + database_pool_overflow - database_pool_checkedin) / (database_pool_size + database_pool_overflow)

---
# 3. ALERTING RULES
alerting_rules:
  groups:
    - name: slo_alerts
      interval: 30s
      rules:
        # CRITICAL: P95 Latency SLO Breach
        - alert: HighLatencyP95
          expr: api:http_request_duration:p95 > 0.120
          for: 5m
          labels:
            severity: critical
            component: api
            slo: latency
          annotations:
            summary: "P95 latency exceeds 120ms SLO"
            description: "P95 latency is {{ $value | humanizeDuration }} (SLO: ≤120ms)"
            runbook: "https://runbooks.scholarshipai.com/high-latency"
            dashboard: "https://scholarshipai.grafana.net/d/golden-signals"
            pagerduty_severity: "critical"
        
        # CRITICAL: High Error Rate
        - alert: HighErrorRate
          expr: api:http_errors:rate5m > 0.001
          for: 5m
          labels:
            severity: critical
            component: api
            slo: availability
          annotations:
            summary: "Error rate exceeds 0.1% SLO"
            description: "Error rate is {{ $value | humanizePercentage }} (SLO: <0.1%)"
            runbook: "https://runbooks.scholarshipai.com/high-error-rate"
            pagerduty_severity: "critical"
        
        # CRITICAL: Service Down
        - alert: ServiceDown
          expr: up{job="scholarship-api"} == 0
          for: 2m
          labels:
            severity: critical
            component: api
          annotations:
            summary: "Scholarship API is down"
            description: "No heartbeat received for 2 minutes"
            runbook: "https://runbooks.scholarshipai.com/service-down"
            pagerduty_severity: "critical"
        
        # WARNING: Database Pool Saturation
        - alert: DatabasePoolSaturation
          expr: api:database_pool:utilization > 0.80
          for: 5m
          labels:
            severity: warning
            component: database
          annotations:
            summary: "Database connection pool >80% saturated"
            description: "Pool utilization: {{ $value | humanizePercentage }}"
            runbook: "https://runbooks.scholarshipai.com/db-saturation"
        
        # WARNING: Redis Unavailable
        - alert: RedisUnavailable
          expr: redis_connection_status == 0
          for: 3m
          labels:
            severity: warning
            component: redis
          annotations:
            summary: "Redis connection lost - fallback to in-memory"
            runbook: "https://runbooks.scholarshipai.com/redis-down"
        
        # INFO: High Traffic
        - alert: HighTraffic
          expr: api:http_requests:rate1m > 100
          for: 10m
          labels:
            severity: info
            component: api
          annotations:
            summary: "Elevated traffic detected"
            description: "Request rate: {{ $value }} RPS (normal: 10-50 RPS)"

---
# 4. ALERTMANAGER CONFIG
alertmanager:
  route:
    receiver: 'pagerduty'
    group_by: ['alertname', 'severity', 'component']
    group_wait: 30s
    group_interval: 5m
    repeat_interval: 4h
    
    # Route critical alerts immediately to PagerDuty
    routes:
      - match:
          severity: critical
        receiver: 'pagerduty'
        continue: true
      
      - match:
          severity: warning
        receiver: 'slack'
        continue: true
      
      - match:
          severity: info
        receiver: 'slack'
  
  receivers:
    # PagerDuty for critical alerts
    - name: 'pagerduty'
      pagerduty_configs:
        - service_key: '<PAGERDUTY_SERVICE_KEY>'
          description: '{{ .GroupLabels.alertname }}: {{ .Annotations.summary }}'
          severity: '{{ .Labels.pagerduty_severity | default "error" }}'
          details:
            runbook: '{{ .Annotations.runbook }}'
            dashboard: '{{ .Annotations.dashboard }}'
            description: '{{ .Annotations.description }}'
            firing_alerts: '{{ range .Alerts }}{{ .Labels.instance }} {{ end }}'
    
    # Slack for all alerts
    - name: 'slack'
      slack_configs:
        - api_url: 'https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXX'
          channel: '#scholarshipai-alerts'
          title: '{{ .GroupLabels.alertname }}'
          text: '{{ .Annotations.summary }}\n{{ .Annotations.description }}'
          color: '{{ if eq .Labels.severity "critical" }}danger{{ else if eq .Labels.severity "warning" }}warning{{ else }}good{{ end }}'
          send_resolved: true

---
# 5. GRAFANA DASHBOARDS
grafana_dashboards:
  - name: "ScholarshipAI - Golden Signals"
    uid: "golden-signals"
    panels:
      # Panel 1: Latency
      - title: "Request Latency (P50, P95, P99)"
        type: "graph"
        datasource: "Prometheus"
        targets:
          - expr: "api:http_request_duration:p50"
            legendFormat: "P50"
          - expr: "api:http_request_duration:p95"
            legendFormat: "P95 (SLO: ≤120ms)"
          - expr: "api:http_request_duration:p99"
            legendFormat: "P99"
        thresholds:
          - value: 120
            color: "red"
            label: "P95 SLO"
      
      # Panel 2: Traffic (RPS)
      - title: "Request Rate (RPS)"
        type: "graph"
        datasource: "Prometheus"
        targets:
          - expr: "api:http_requests:rate1m"
            legendFormat: "Requests/sec"
      
      # Panel 3: Errors
      - title: "Error Rate"
        type: "graph"
        datasource: "Prometheus"
        targets:
          - expr: "api:http_errors:rate5m * 100"
            legendFormat: "Error Rate %"
        thresholds:
          - value: 0.1
            color: "red"
            label: "SLO: 0.1%"
      
      # Panel 4: Saturation
      - title: "Resource Saturation"
        type: "graph"
        datasource: "Prometheus"
        targets:
          - expr: "system_cpu_usage_percent"
            legendFormat: "CPU %"
          - expr: "system_memory_usage_percent"
            legendFormat: "Memory %"
          - expr: "api:database_pool:utilization * 100"
            legendFormat: "DB Pool %"
        thresholds:
          - value: 80
            color: "orange"
          - value: 90
            color: "red"
      
      # Panel 5: Apdex Score
      - title: "Apdex Score (User Satisfaction)"
        type: "stat"
        datasource: "Prometheus"
        targets:
          - expr: "(sum(rate(http_request_duration_seconds_bucket{le=\"0.120\"}[5m])) + sum(rate(http_request_duration_seconds_bucket{le=\"0.480\"}[5m])) / 2) / sum(rate(http_request_duration_seconds_count[5m]))"
            legendFormat: "Apdex"
        thresholds:
          - value: 0.7
            color: "red"
          - value: 0.85
            color: "orange"
          - value: 0.94
            color: "green"

---
# 6. SYNTHETIC MONITORING (Pingdom/UptimeRobot)
synthetic_checks:
  - name: "API Health Check"
    url: "https://scholarship-api-jamarrlmayes.replit.app/health"
    interval: 60  # seconds
    regions: ["us-east", "us-west", "eu-central"]
    expected_status: 200
    alert_on_failure: true
  
  - name: "Search Endpoint"
    url: "https://scholarship-api-jamarrlmayes.replit.app/api/v1/search?q=test"
    interval: 300  # seconds
    headers:
      Authorization: "Bearer ${SYNTHETIC_TEST_TOKEN}"
    expected_status: 200
    alert_on_failure: true

---
# 7. LOG AGGREGATION (Loki)
loki:
  clients:
    - url: "${LOKI_URL}/loki/api/v1/push"
      tenant_id: "scholarshipai"
  
  pipeline_stages:
    # Parse structured JSON logs
    - json:
        expressions:
          level: level
          timestamp: timestamp
          trace_id: trace_id
          user_id: user_id
          endpoint: endpoint
    
    # Extract labels
    - labels:
        level:
        trace_id:
        endpoint:
    
    # Drop debug logs in production
    - drop:
        expression: '.*level="debug".*'
        drop_counter_reason: "debug_logs_dropped"

---
# 8. REMOTE COMMANDS CONFIG
remote_commands:
  # Kill-switch command
  - name: "kill_switch"
    endpoint: "/internal/commands/kill-switch"
    method: "POST"
    auth_required: true
    signature_verification: true
    
    payload:
      reason: "Emergency maintenance"
      operator: "sre_oncall"
      duration_minutes: 30
    
    response_validation:
      - field: "status"
        expected: "acknowledged"
      - field: "maintenance_mode"
        expected: true
  
  # Cache refresh command
  - name: "refresh_cache"
    endpoint: "/internal/commands/refresh-cache"
    method: "POST"
    auth_required: true
    
    response_validation:
      - field: "caches_cleared"
        expected: true

---
# 9. RUNBOOKS (Quick Links)
runbooks:
  - name: "High Latency (P95 >120ms)"
    url: "https://runbooks.scholarshipai.com/high-latency"
    scenarios:
      - "Database connection pool exhausted → Scale pool, check queries"
      - "External API slow → Check timeouts, enable circuit breaker"
      - "Memory leak → Restart pod, investigate with profiler"
  
  - name: "High Error Rate (>0.1%)"
    url: "https://runbooks.scholarshipai.com/high-error-rate"
    scenarios:
      - "Database errors → Check connection, check queries"
      - "Authentication errors → Check JWT secret, token expiry"
      - "WAF false positives → Review WAF logs, adjust rules"
  
  - name: "Service Down (No Heartbeat)"
    url: "https://runbooks.scholarshipai.com/service-down"
    scenarios:
      - "Application crash → Check logs, restart pod"
      - "Database unreachable → Check DB health, failover"
      - "Network issue → Check DNS, firewall rules"
  
  - name: "Database Saturation (>80% pool)"
    url: "https://runbooks.scholarshipai.com/db-saturation"
    scenarios:
      - "Connection leak → Find and kill long-running queries"
      - "Traffic spike → Enable load shedding, scale pool"
      - "Slow queries → Add indexes, optimize queries"

---
# 10. ON-CALL ROTATION (PagerDuty)
oncall_schedule:
  primary:
    - name: "SRE Lead"
      contact: "sre-lead@scholarshipai.com"
      phone: "+1-xxx-xxx-xxxx"
      schedule: "Mon-Fri 9am-5pm PST"
  
  secondary:
    - name: "Platform Lead"
      contact: "platform-lead@scholarshipai.com"
      phone: "+1-xxx-xxx-xxxx"
      schedule: "After hours, weekends"
  
  escalation:
    - level: 1
      timeout: 15  # minutes
      notify: ["primary"]
    
    - level: 2
      timeout: 30
      notify: ["primary", "secondary"]
    
    - level: 3
      timeout: 60
      notify: ["primary", "secondary", "cto"]

---
# END OF COMMAND CENTER CONFIG
